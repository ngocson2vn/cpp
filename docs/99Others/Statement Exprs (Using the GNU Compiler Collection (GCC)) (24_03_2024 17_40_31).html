<!DOCTYPE html> <html style><!--
 Page saved with SingleFile 
 url: https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Statement-Exprs.html 
 saved date: Sun Mar 24 2024 17:40:31 GMT+0800 (Singapore Standard Time)
--><!-- Created by GNU Texinfo 7.0dev, http://www.gnu.org/software/texinfo/ --><meta charset=utf-8>
<title>Statement Exprs (Using the GNU Compiler Collection (GCC))</title>
<meta name=description content="Statement Exprs (Using the GNU Compiler Collection (GCC))">
<meta name=keywords content="Statement Exprs (Using the GNU Compiler Collection (GCC))">
<meta name=resource-type content=document>
<meta name=distribution content=global>
<meta name=Generator content=makeinfo>
<meta name=viewport content="width=device-width,initial-scale=1">
<link href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/index.html rel=start title=Top>
<link href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Indices.html rel=index title=Indices>
<link href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/index.html#SEC_Contents rel=contents title="Table of Contents">
<link href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/C-Extensions.html rel=up title="C Extensions">
<link href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Local-Labels.html rel=next title="Local Labels">
<style><!--a.copiable-link{visibility:hidden;text-decoration:none;line-height:0em}span:hover a.copiable-link{visibility:visible}--></style>
<style>body{color:black}a:link{color:#0066bb;text-decoration:none}a:visited{color:#003399;text-decoration:none}a:hover{color:darkorange;text-decoration:none}:root{--contents-width-max:60em;--backdrop:#e7e7e7;--contents-backdrop:#ffffff;--example-background:#f2f2f2;--defining-border:#c2c2c2;--table-color-even:var(--contents-backdrop);--table-color-odd:var(--backdrop)}html{margin:0;padding:0;background-color:var(--backdrop);line-height:1.3}body{margin:0 auto;padding:1em 3px;max-width:min(max(75vw,var(--contents-width-max)),130em);min-height:100vh;background-color:var(--contents-backdrop);border:1px solid var(--defining-border)}@media only screen and (min-width:50em){body{padding:1em 3em}div.smallexample{margin-left:1.1em}}@media (hover:none){a.copiable-link{visibility:visible}}div.smallexample{margin-left:2.2em;border-radius:0.3em;border:1px solid var(--defining-border);background-color:var(--example-background);padding:0 1em;overflow:auto}h3{margin:0.5em 0 0.7em 0}</style>
<style id=ctre_styles>@media (prefers-color-scheme:dark){}</style><meta name=referrer content=no-referrer><link type=image/x-icon rel="shortcut icon" href=data:image/vnd.microsoft.icon;base64,AAABAAEAEBAQAAAAAABoAwAAFgAAACgAAAAQAAAAIAAAAAEAGAAAAAAAAAMAABILAAASCwAAAAAAAAAAAADc3Nzc3Nzc3Nz/wv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv//wv//wv/c3Nzc3Nzc3Nzc3Nzc3Nz/wv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv//wv/c3Nzc3Nzc3Nz/wv/Fwv/Fwv8AAAAAAADFwv/Fwv8AAAAAAADFwv/Fwv8AAAAAAAD/wv/c3Nzc3Nz/wv/Fwv8AAADFwv8AAADFwv8AAADFwv/Fwv/Fwv8AAADFwv/Fwv/Fwv/c3Nzc3Nz/wv/Fwv8AAADFwv/Fwv/Fwv8AAADFwv/Fwv/Fwv8AAADFwv/Fwv/Fwv//wv//wv//wv/Fwv/Fwv8AAAAAAADFwv/Fwv8AAAAAAADFwv/Fwv8AAAAAAADFwv//wv//wv//wv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv/Fwv//wv//wv//wv/Fwv/Fwv/Fwv/Fwv/Fwv8AgYMAgYMAQEH/AP//AP/Fwv/Fwv/Fwv//wv//wv//wv/Fwv/Fwv/Fwv8AQEEAgYMAgYMAgYMAgYP/AP8AAAAAQEHFwv/Fwv//wv/c3Nz/wv/Fwv/Fwv//wv8AAAAAQEEAgYMAgYMAgYMAAAAAgYMAgYMAgYP/wv/c3Nzc3Nz/wv/Fwv/Fwv//wv8AAAAAQEEAgYMAgYMAgYMAgYMAgYMAgYMAgYP/wv/c3Nzc3Nz/wv//wv/Fwv//wv//wv8AAAAAQEEAgYMAgYMAgYMAgYMAQEEAQEH/wv/c3Nzc3Nzc3Nz/wv/Fwv/Fwv//wv//AP8AQEEAgYMAAAAAgYMAAAD/wv//wv/c3Nzc3Nzc3Nzc3Nzc3Nz/wv/Fwv/Fwv//wv+DgYODgYMAgYMAgYODgYODgYPc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nz/wv/Fwv+koaSDgYP/AP//AP//AP//wv+DgYOkoaTc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nz/wv/Fwv+DgYOkoaTFwv/Fwv+koaSDgYPc3Nzc3Nzc3NzgB///wAP//4AB//+AAf//gAD//wAA//8AAP//AAD//wAA//+AAf//gAH//4AB///AA///4Af///AD///4B///><link rel=canonical href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Statement-Exprs.html><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body lang=en_US>
<div class=section-level-extent id=Statement-Exprs>
<div class=nav-panel>
<p>
Next: <a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Local-Labels.html accesskey=n rel=next>Locally Declared Labels</a>, Up: <a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/C-Extensions.html accesskey=u rel=up>Extensions to the C Language Family</a> &nbsp; [<a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/index.html#SEC_Contents title="Table of contents" rel=contents>Contents</a>][<a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Indices.html title=Index rel=index>Index</a>]</p>
</div>
<hr>
<h3 class=section id=Statements-and-Declarations-in-Expressions><span>6.1 Statements and Declarations in Expressions<a class=copiable-link href=#Statements-and-Declarations-in-Expressions> ¶</a></span></h3>
<a class=index-entry-id id=index-statements-inside-expressions></a>
<a class=index-entry-id id=index-declarations-inside-expressions></a>
<a class=index-entry-id id=index-expressions-containing-statements></a>
<a class=index-entry-id id=index-macros_002c-statements-in-expressions></a>
<p>A compound statement enclosed in parentheses may appear as an expression
in GNU C. This allows you to use loops, switches, and local variables
within an expression.
</p>
<p>Recall that a compound statement is a sequence of statements surrounded
by braces; in this construct, parentheses go around the braces. For
example:
</p>
<div class="example smallexample">
<pre class=example-preformatted>({ int y = foo (); int z;
   if (y &gt; 0) z = y;
   else z = - y;
   z; })
</pre></div>
<p>is a valid (though slightly more complex than necessary) expression
for the absolute value of <code class=code>foo ()</code>.
</p>
<p>The last thing in the compound statement should be an expression
followed by a semicolon; the value of this subexpression serves as the
value of the entire construct. (If you use some other kind of statement
last within the braces, the construct has type <code class=code>void</code>, and thus
effectively no value.)
</p>
<p>This feature is especially useful in making macro definitions “safe” (so
that they evaluate each operand exactly once). For example, the
“maximum” function is commonly defined as a macro in standard C as
follows:
</p>
<div class="example smallexample">
<pre class=example-preformatted>#define max(a,b) ((a) &gt; (b) ? (a) : (b))
</pre></div>
<a class=index-entry-id id=index-side-effects_002c-macro-argument></a>
<p>But this definition computes either <var class=var>a</var> or <var class=var>b</var> twice, with bad
results if the operand has side effects. In GNU C, if you know the
type of the operands (here taken as <code class=code>int</code>), you can avoid this
problem by defining the macro as follows:
</p>
<div class="example smallexample">
<pre class=example-preformatted>#define maxint(a,b) \
  ({int _a = (a), _b = (b); _a &gt; _b ? _a : _b; })
</pre></div>
<p>Note that introducing variable declarations (as we do in <code class=code>maxint</code>) can
cause variable shadowing, so while this example using the <code class=code>max</code> macro
produces correct results:
<div class="example smallexample">
<pre class=example-preformatted>int _a = 1, _b = 2, c;
c = max (_a, _b);
</pre></div>
<p>this example using maxint will not:
<div class="example smallexample">
<pre class=example-preformatted>int _a = 1, _b = 2, c;
c = maxint (_a, _b);
</pre></div>
<p>This problem may for instance occur when we use this pattern recursively, like
so:
</p>
<div class="example smallexample">
<pre class=example-preformatted>#define maxint3(a, b, c) \
  ({int _a = (a), _b = (b), _c = (c); maxint (maxint (_a, _b), _c); })
</pre></div>
<p>Embedded statements are not allowed in constant expressions, such as
the value of an enumeration constant, the width of a bit-field, or
the initial value of a static variable.
</p>
<p>If you don’t know the type of the operand, you can still do this, but you
must use <code class=code>typeof</code> or <code class=code>__auto_type</code> (see <a class=pxref href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Typeof.html>Referring to a Type with <code class=code>typeof</code></a>).
</p>
<p>In G++, the result value of a statement expression undergoes array and
function pointer decay, and is returned by value to the enclosing
expression. For instance, if <code class=code>A</code> is a class, then
</p>
<div class="example smallexample">
<pre class=example-preformatted>        A a;

        ({a;}).Foo ()
</pre></div>
<p>constructs a temporary <code class=code>A</code> object to hold the result of the
statement expression, and that is used to invoke <code class=code>Foo</code>.
Therefore the <code class=code>this</code> pointer observed by <code class=code>Foo</code> is not the
address of <code class=code>a</code>.
</p>
<p>In a statement expression, any temporaries created within a statement
are destroyed at that statement’s end. This makes statement
expressions inside macros slightly different from function calls. In
the latter case temporaries introduced during argument evaluation are
destroyed at the end of the statement that includes the function
call. In the statement expression case they are destroyed during
the statement expression. For instance,
</p>
<div class="example smallexample">
<pre class=example-preformatted>#define macro(a)  ({__typeof__(a) b = (a); b + 3; })
template&lt;typename T&gt; T function(T a) { T b = a; return b + 3; }

void foo ()
{
  macro (X ());
  function (X ());
}
</pre></div>
<p>has different places where temporaries are destroyed. For the
<code class=code>macro</code> case, the temporary <code class=code>X</code> is destroyed just after
the initialization of <code class=code>b</code>. In the <code class=code>function</code> case that
temporary is destroyed when the function returns.
</p>
<p>These considerations mean that it is probably a bad idea to use
statement expressions of this form in header files that are designed to
work with C++. (Note that some versions of the GNU C Library contained
header files using statement expressions that lead to precisely this
bug.)
</p>
<p>Jumping into a statement expression with <code class=code>goto</code> or using a
<code class=code>switch</code> statement outside the statement expression with a
<code class=code>case</code> or <code class=code>default</code> label inside the statement expression is
not permitted. Jumping into a statement expression with a computed
<code class=code>goto</code> (see <a class=pxref href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Labels-as-Values.html>Labels as Values</a>) has undefined behavior.
Jumping out of a statement expression is permitted, but if the
statement expression is part of a larger expression then it is
unspecified which other subexpressions of that expression have been
evaluated except where the language definition requires certain
subexpressions to be evaluated before or after the statement
expression. A <code class=code>break</code> or <code class=code>continue</code> statement inside of
a statement expression used in <code class=code>while</code>, <code class=code>do</code> or <code class=code>for</code>
loop or <code class=code>switch</code> statement condition
or <code class=code>for</code> statement init or increment expressions jumps to an
outer loop or <code class=code>switch</code> statement if any (otherwise it is an error),
rather than to the loop or <code class=code>switch</code> statement in whose condition
or init or increment expression it appears.
In any case, as with a function call, the evaluation of a
statement expression is not interleaved with the evaluation of other
parts of the containing expression. For example,
</p>
<div class="example smallexample">
<pre class=example-preformatted>  foo (), (({ bar1 (); goto a; 0; }) + bar2 ()), baz();
</pre></div>
<p>calls <code class=code>foo</code> and <code class=code>bar1</code> and does not call <code class=code>baz</code> but
may or may not call <code class=code>bar2</code>. If <code class=code>bar2</code> is called, it is
called after <code class=code>foo</code> and before <code class=code>bar1</code>.
</p>
</div>
<hr>
<div class=nav-panel>
<p>
Next: <a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Local-Labels.html>Locally Declared Labels</a>, Up: <a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/C-Extensions.html>Extensions to the C Language Family</a> &nbsp; [<a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/index.html#SEC_Contents title="Table of contents" rel=contents>Contents</a>][<a href=https://gcc.gnu.org/onlinedocs/gcc-13.2.0/gcc/Indices.html title=Index rel=index>Index</a>]</p>
</div>
